{% load jalali_filters %}
{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت تردد نئونی</title>
    <!-- لود کردن فونت فارسی وزیر -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet"
          type="text/css"/>

    <link rel="stylesheet" href="{% static 'hrm/css/style.css' %}">
</head>
<body>

<!-- هدر سایت -->
<header>
    <h1>مدیریت تردد نئونی</h1>
    <button class="btn-add" onclick="openEntryModal()">
        <span>+</span> ثبت ورود جدید
    </button>
</header>

<!-- کانتینر اصلی جدول -->
<div class="container">
    <div class="table-container">
        <table id="attendanceTable">
            <thead>
            <tr>
                <th>نام کارمند</th>
                <th>روز هفته</th>
                <th>تاریخ</th>
                <th>ساعت ورود</th>
                <th>تاخییر روز</th>
                <th>ساعت خروج</th>
                <th>عملیات</th>
            </tr>
            </thead>
            <tbody>
            {% if not entes %}
            <tr id="empty-msg">
                <td colspan="6" style="padding: 40px;">هنوز ترددی ثبت نشده است...</td>
            </tr>
            {% else %}
            {% for ent in entes %}
            <tr id="row-1" style="animation: 0.5s ease 0s 1 normal none running fadeIn;">
                <td>
                    <strong style="color:white; font-size:1.05rem;">{{ent.name}}</strong>
                </td>
                <td>
                    <span style="color: var(--secondary-neon);">{{ent.day|jalali_weekday}}</span>
                </td>
                <td style="color: #ccc;">
                    {{ ent.enter_date|date:"Y/m/d" }}
                </td>
                <td>
                    <span class="status-badge status-in">{{ ent.enter_time|time:"H:i" }}</span>
                </td>
                <td>
                    {% if ent.late == 0 %}
                        <span class="status-badge status-ok">بدون تاخیر</span>
                    {% elif ent.late == 1 and ent.late_accept == 1 %}
                        <span class="status-badge status-ok" >✔ {{ ent.late_time }}</span>
                    {% elif ent.late == 1 and ent.late_accept == 0 %}
                        <span class="status-badge status-late" onclick="openLateModal('{{ ent.exid }}', '{{ ent.name }}')">{{ ent.late_time }}</span>
                    {% endif %}
                </td>
                <td id="exit-cell-1" style="color: var(--text-muted);">
                    {% if ent.exit_time %}
                    <span class="status-badge status-out">{{ ent.exit_time|time:"H:i" }}</span>
                    {% else %}
                    ---
                    {% endif %}
                </td>
                <td>
                    {% if ent.exit_time %}
                    <button class="btn-exit btn-exit-closed" disabled>بسته شد</button>
                    {% else %}
                    <button class="btn-exit" onclick="openExitModal('{{ ent.exid }}', '{{ ent.name }}')">ثبت خروج
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal-overlay" id="entryModal">
    <div class="modal">
        <form method="post" action="{% url 'addEnterTime' %}">
            {% csrf_token %}
            <h2>ثبت ورود جدید</h2>
            <div class="form-group">
                <label>انتخاب کارمند:</label>
                <!-- لیست کشویی کارمندان -->
                <select id="entryName" name="employee">
                    <option value="" disabled selected>لطفا انتخاب کنید...</option>
                    {% for emp in emps %}
                    <option value="{{ emp.eid }}">{{ emp.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex: 1;pointer-events: none;">
                    <label>روز هفته:</label>
                    <select id="entryDay">
                        <option value="{{ today_date|jalali_weekday }}">{{ today_date|jalali_weekday }}</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label>تاریخ:</label>
                    <input type="text" id="entryDate" name="entryDate" placeholder="1402-02-24"
                           value="{{ today_date }}">
                </div>
            </div>
            <div class="form-group">
                <label>ساعت ورود:</label>
                <input type="time" name="entryTime" id="entryTime">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('entryModal')">بیخیال</button>
                <button type="submit" class="btn-submit">ثبت کن</button>
            </div>
        </form>
    </div>
</div>

<!-- پاپ‌آپ ثبت خروج -->
<div class="modal-overlay" id="exitModal">
    <div class="modal">
        <form method="post" action="{% url 'addExitTime' %}">
            {% csrf_token %}

            <h2>ثبت خروج</h2>
            <p style="text-align: center; color: var(--primary-neon); margin-bottom: 20px;">
                <span id="exitEmployeeName" style="font-weight: bold; font-size: 1.1rem;">---</span>
            </p>
            <div class="form-group">
                <label>ساعت خروج:</label>
                <input type="time" id="exitTimeInput" name="exteryTime">
            </div>
            <input type="hidden" name="exid" id="currentRowId">

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('exitModal')">انصراف</button>
                <button type="submit" class="btn-submit btn-submit-ex">تایید خروج</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="lateModal">
    <div class="modal">
        <form method="post" action="{% url 'editLateAccept' %}">
            {% csrf_token %}

            <h2>آیا تاخییر موجه است ؟</h2>
            <p style="text-align: center; color: var(--primary-neon); margin-bottom: 20px;">
                <span id="lateEmployeeName" style="font-weight: bold; font-size: 1.1rem;">---</span>
            </p>
            <div class="form-group">
                <label>موجه</label>
                <input class="lateCheck" type="checkbox" id="lateCheckbox" name="lateBool" style="transform: scale(1.5);">
            </div>
            <input type="hidden" name="exid" id="currentEmployeeId">

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('lateModal')">انصراف</button>
                <button type="submit" class="btn-submit btn-submit-ex">تایید تغییرات</button>
            </div>
        </form>
    </div>
</div>

<script src="{% static 'hrm/js/script.js' %}"></script>
</body>
</html>
